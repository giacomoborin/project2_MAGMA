

function ECDSA_Signing(q,E,G,r,d,m)
/*
     INPUTS: -q is the number of elements of the finite
              field over which is defined the curve
             -E is the elliptic curve
             -G is the base point of E
             -r is the order of the point G
             -d is Alice’s private key
             -m is the message to be signed
     OUTPUT: -(R,s) is the digital signature
*/
	
	// Choose random element e mod r.
	k := Random(1,r-1);
	// Compute R = kG ∈ E(Fp) and then,
	R := k*G;
	//	
	s := (m + d*Integers()!(R[1]) )*Modinv(k,r) mod r;
	return R,s;
end function;


function ECDSA_Verification(q,E,G,r,Q,m,R,s)
/*
     INPUTS: -q is the number of elements of the finite
              field over which is defined the curve
             -E is the elliptic curve
             -G is the base point of E
             -r is the order of the point G
             -Q is Alice‚Äôs public key
             -m is the message to be signed
             -R is the first part of the digital signature
             -s is the second part of the digital signature
     OUTPUT: -bool is a boolean that says if the
              sign is valid
*/
	i := Modinv(s,r);
	u1 := m*i mod r;
	u2 := Integers()!(R[1])*i mod r;
	return (u1*G + u2*Q) eq R;
end function;


//-------------------------------------------
//----------------TEST PART------------------
//-------------------------------------------

TestECDSA:=
[*
    <<<96705487, 96321645, 73680265, [ 95918504, 60746286, 1 ], 96705967, [
    7373587, 66475414, 1 ]>, <62614351>>, [ 4582502, 72612985, 11236579,
    82294360, 47764652, 20902581, 85669403, 61859552, 39294838, 95393763,
    84620353, 95057896, 76926639, 64582162, 86041672, 93429304, 10287053,
    52905683, 51782755, 60018596 ]>,
    <<<412501253, 235366588, 401931994, [ 142077190, 49273586, 1 ], 412511329, [
    112426865, 35282760, 1 ]>, <122206843>>, [ 399898685, 132739433, 22451845,
    343318498, 305241301, 365603160, 219580261, 260805408, 187647252, 148755126,
    175576620, 131595461, 81808666, 61891512, 139978320, 261585652, 328937269,
    313246256, 144454293, 155760304 ]>,
    <<<18597069643, 3436973890, 12673243696, [ 16232714921, 6699081847, 1 ],
    18597208843, [ 8473005242, 13281473699, 1 ]>, <3343969849>>, [ 12538421186,
    3014198635, 965379954, 4751154193, 2652812998, 11023994500, 9095632639,
    7424363170, 5815637927, 9556552782, 2137230897, 12599561776, 7010779965,
    7080046491, 2069788445, 12343059662, 11539706564, 4823961977, 14589558899,
    13886192771 ]>,
    <<<26065687, 2257892, 7123335, [ 12120619, 3112089, 1 ], 26061631, [
    10613196, 23736167, 1 ]>, <15205319>>, [ 20154112, 16843030, 22051381,
    15542190, 14632197, 16034639, 5287579, 20337393, 19690988, 1618173,
    12306427, 11118028, 9438140, 1504004, 15228840, 1262045, 9610884, 10028546,
    20884010, 6597277 ]>,
    <<<40268351, 6771893, 10011194, [ 29320081, 1370800, 1 ], 40268497, [
    39837181, 19425747, 1 ]>, <31147990>>, [ 23235790, 13552554, 35677792,
    14680901, 8801468, 29375405, 40070618, 539369, 35661459, 8677876, 6322085,
    33560712, 31252182, 17812737, 23334611, 28785295, 39222998, 14997867,
    11071671, 9862243 ]>,
    <<<12766282159, 8919298006, 11510067199, [ 678495229, 6934188434, 1 ],
    12766312187, [ 186205496, 7144886594, 1 ]>, <329090434>>, [ 7159975861,
    10097776047, 10255271776, 9453846409, 3425794679, 5081741875, 4236578866,
    2771688045, 8787589513, 9532156248, 4194383122, 4986690028, 10902171703,
    2299477376, 9684734059, 4322559626, 1492825629, 8659310463, 9860727211,
    5506947173 ]>,
    <<<219855847, 137754793, 92988900, [ 40919323, 8123157, 1 ], 219859259, [
    162404915, 72031667, 1 ]>, <196177876>>, [ 134253092, 115609151, 30415485,
    27369799, 193339501, 80427435, 123695016, 207602042, 119269891, 127146166,
    68968207, 38663073, 84612360, 216723717, 33618847, 1233133, 110420150,
    68172681, 87556838, 82920539 ]>,
    <<<2017806751, 2004584542, 1496187895, [ 1407506714, 1777196339, 1 ],
    2017757813, [ 2004534357, 260114603, 1 ]>, <1402587806>>, [ 1907583214,
    577153344, 639406040, 164238620, 844225273, 28369151, 986069240, 1979140447,
    138313565, 314505536, 282372102, 2013806273, 1212013124, 1526283049,
    1543914343, 1425707208, 1594701420, 820547416, 1347944128, 716170777 ]>,
    <<<65558567, 39901285, 10887089, [ 11680101, 20490030, 1 ], 65552743, [
    33795565, 65108392, 1 ]>, <11412751>>, [ 38709367, 1869950, 31824864,
    14542916, 9248220, 47094816, 22696575, 51731773, 5519810, 34937593,
    60865993, 49631110, 5857791, 54932426, 20180994, 18590751, 5223317,
    34560313, 33160388, 54337059 ]>,
    <<<19887172873, 16812947357, 5923784528, [ 19781270620, 2714241903, 1 ],
    19887280249, [ 11714605673, 12862535670, 1 ]>, <3953275476>>, [ 2884545158,
    13088952951, 2572401500, 18507932933, 17850497218, 8659492562, 11649962645,
    4336130972, 166930794, 19771978292, 1944883574, 2671715259, 1119844589,
    5287121182, 12339976381, 7091441335, 5543738766, 2973463889, 16844376421,
    1143443715 ]>
*];


procedure test_ECDSA()
	for test in TestECDSA do
		el:=test[1];
		M:=test[2];
		q:=el[1][1];
		E:=EllipticCurve( [GF(q)!el[1][2],el[1][3]]  );
		P:=E!el[1][4];
		r:=el[1][5];
		d:=el[2][1];
		for m in M do
			R,s:=ECDSA_Signing(q,E,P,r,d,m);
			if not ECDSA_Verification(q, E, P, r, E!el[1][6], m, E!R, s) then
				"Error! These are test and m:\n";
				test; m; 
				break; 
			end if;
		end for;
	end for;
end procedure;

time test_ECDSA();

